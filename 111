---- CTE Ð´Ð»Ñ Ð²Ð²Ð¾Ð´Ð° Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð² Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
-- Ð²Ð²Ð¾Ð´ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÑƒÑŽÑ‰ÐµÐ³Ð¾ Ð˜ÐÐ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
with inn_list as (
select '212341234' as inn
)

-- Ð²Ð²Ð¾Ð´ Ð¿ÐµÑ€Ð¸Ð¾Ð´Ð° Ð¿Ð¾ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¸Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
, date_list as (
select '2020-01-01' as date_start, '2025-11-01' as date_end 
)

-- Ð²Ð²Ð¾Ð´ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð° Ñ‚Ð¸Ð¿Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° (Ð°Ð¿Ð¿Ð»Ð¸ÐºÐ°Ð½Ñ‚ Ð¸Ð»Ð¸ Ð±ÐµÐ½ÐµÑ„Ð¸Ñ†Ð¸Ð°Ñ€). is_applicant Ð¸ is_benefitiary Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð¸ÑÐºÐ»ÑŽÑ‡Ð°ÑŽÑ‰Ð¸Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°
, client_flag as (
select 1 as is_applicant, 0 as is_benefitiary
)

---- CTE Ð´Ð»Ñ Ð¾Ñ‚Ð±Ð¾Ñ€Ð° Ð½ÑƒÐ¶Ð½Ñ‹Ñ… ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð²/ÑÐ´ÐµÐ»Ð¾Ðº/Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹
, subj_list as (
select distinct 
  subj_h.subj_dp_code
  , subj_h.subj_sk
from usl_tradefin_ndl_uvdo_snp.subj_h
where inn_num in (select inn from inn_list)
union
select distinct 
  subj_h.subj_dp_code
  , subj_h.subj_sk 
from usl_subj_org_idl_snp.subj_h
where inn_num in (select inn from inn_list)
)

, agr_sk_list_pre as (
select distinct 
  agr_proc.agr_sk
from usl_tradefin_ndl_uvdo_snp.agr_proc
inner join usl_tradefin_ndl_uvdo_snp.agr
  on agr_proc.agr_sk = agr.agr_sk
inner join usl_tradefin_ndl_uvdo_snp.letter_cred_type lct
  on agr.letter_cred_type_sk = lct.letter_cred_type_sk
where 
  (lct.sid in ('1', '2', '10') or agr.type_code in ('ind', 'ind_draft'))
  and (
    agr_proc.letter_cred_org_buyer_subj_sk in (select subj_sk from subj_list)
--    or agr_proc.docum_tran_seller_subj_sk in (select subj_sk from subj_list)
  )
)

, plan_payment as (
select distinct
  plan.plan_payment_agr_sk as agr_sk
from agr_sk_list_pre
inner join usl_tradefin_ndl_uvdo_snp.letter_cred_org_plan_payment plan
  on agr_sk_list_pre.agr_sk = plan.plan_payment_agr_sk
cross join date_list
where 
  split(plan.sid, '\\|')[0] in ('VOZMPA4410', 'VOZMPA')
  and coalesce(plan.letter_cred_org_plan_payment_amt, 0) > 0
  and plan.letter_cred_org_plan_payment_dt >= date_list.date_start
)

, agr_sk_list_fin as (
select distinct
  agr.agr_sk
  , agr.sid
  , agr.num
  , agr_fin.docum_tran_amt
  , agr_fin.docum_tran_crncy_sk
  , agr.letter_cred_coverage_flag
  , agr.letter_cred_source_coverage_type_sk
  , agr.open_dt
  , agr.close_dt
from agr_sk_list_pre pre
inner join usl_tradefin_ndl_uvdo_snp.agr
  on pre.agr_sk = agr.agr_sk
inner join usl_tradefin_ndl_uvdo_snp.agr_fin
  on agr.agr_sk = agr_fin.agr_sk
left join plan_payment
  on agr.agr_sk = plan_payment.agr_sk
cross join date_list
where
  agr.open_dt < date_list.date_end
  and (
    agr.close_dt is null
    or plan_payment.agr_sk is not null
    or (agr.close_dt > date_list.date_start and agr.close_dt < date_list.date_end)
  )
  and agr_fin.end_dt = '9999-12-31'
)

, operations_list as (
select distinct
  optn.agr_sk
  , optn.optn_dttm
  , optn.type_code
  , optn.sum_opt_amt
  , optn.crncy_dp_code
  , optn.crncy_sk
  , toptn.group_code
from agr_sk_list_fin
inner join usl_tradefin_ndl_uvdo_snp.optn
  on agr_sk_list_fin.agr_sk = optn.agr_sk
cross join date_list
left join usl_tradefin_ndl_uvdo_snp.toptn
  on optn.toptn_sk = toptn.toptn_sk
where 
  optn.optn_dttm >= date_list.date_start
  and optn.optn_dttm <= date_list.date_end
)

---- ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ñ€Ð°ÑÑ‡ÐµÑ‚Ð½Ñ‹Ðµ CTE
, A AS
(
select 
  agr.agr_sk
  , agr.num
  , sum(coalesce(optn.sum_opt_amt, 0)) as nSumPercent
  , optn.crncy_sk
from agr_sk_list_fin agr
inner join operations_list optn
  on agr.agr_sk = optn.agr_sk
where 1 = 1
  and optn.group_code in ('PayProc')
  and optn.type_code = 'Operation'
group by agr.agr_sk, optn.crncy_sk, agr.num
)

, B AS
(
select 
  agr.agr_sk
  , agr.num
  , sum(coalesce(optn.sum_opt_amt, 0)) as nSumDeferSB
  , optn.crncy_sk
from agr_sk_list_fin agr
inner join operations_list optn
  on agr.agr_sk = optn.agr_sk
where 1 = 1
  and optn.group_code in ('DefPayFee', 'DefPayFeeGS', 'PayCredit', 'PayCredit5')
  and optn.type_code = 'Commission'
group by agr.agr_sk, optn.crncy_sk, agr.num
)

, D AS      -- ÐžÑ‚Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ Ð² Ð²Ð°Ð»ÑŽÑ‚Ðµ ÑÐ´ÐµÐ»ÐºÐ¸
(
select 
  agr.agr_sk
  , agr.num
  , round(sum(coalesce(optn.sum_opt_amt, 0)), 2) as nSumBankPay
  , optn.crncy_sk
from agr_sk_list_fin agr
inner join operations_list optn
  on agr.agr_sk = optn.agr_sk
where 1 = 1
  and optn.group_code in ('BankPay')
  and optn.type_code = 'Operation'
group by agr.agr_sk, optn.crncy_sk, agr.num
)

, Drub AS     -- ÐžÑ‚Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ Ð² Ñ€ÑƒÐ±Ð»ÑÑ…
(
select 
  agr.agr_sk
  , agr.num
  , round(sum(
      case
        when crncy.digital_code = '643' then optn.sum_opt_amt
        when crncy.digital_code != '643' then (optn.sum_opt_amt * r_dt.rub_rate_amt) / r_dt.qty_rub_cnt
        end), 2) as nSumBankPay
  , optn.crncy_sk
from agr_sk_list_fin agr
inner join operations_list optn
  on agr.agr_sk = optn.agr_sk
left join usl_rdm_idl_spark_snp.crncy
  on optn.crncy_sk = crncy.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate r
  on crncy.crncy_sk = r.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate_dt r_dt
  on r.cbr_exchange_rate_sk = r_dt.cbr_exchange_rate_sk
  and r_dt.point_dt = current_date
where 1 = 1
  and optn.group_code in ('BankPay')
  and optn.type_code = 'Operation'
group by agr.agr_sk, optn.crncy_sk, agr.num
)

, E AS        -- ÐŸÐ»Ð°Ñ‚ÐµÐ¶Ð¸ Ð² Ð²Ð°Ð»ÑŽÑ‚Ðµ ÑÐ´ÐµÐ»ÐºÐ¸
(
select 
  agr.agr_sk
  , agr.num
  , round(sum(
      case
        when agr.docum_tran_crncy_sk = optn.crncy_sk then optn.sum_opt_amt
        when crncy.digital_code != '643' and crncy_agr.digital_code = '643' then (optn.sum_opt_amt * r_dt.rub_rate_amt) / r_dt.qty_rub_cnt
        when crncy.digital_code = '643' and crncy_agr.digital_code != '643' then (optn.sum_opt_amt * r_dt_agr.qty_rub_cnt) / r_dt_agr.rub_rate_amt
        when crncy.digital_code != '643' and crncy_agr.digital_code != '643' then (optn.sum_opt_amt * r_dt.rub_rate_amt * r_dt_agr.qty_rub_cnt) / (r_dt.qty_rub_cnt * r_dt_agr.rub_rate_amt) 
        end), 2) as nSumPay
  , optn.crncy_sk
from agr_sk_list_fin agr
inner join operations_list optn
  on agr.agr_sk = optn.agr_sk
  
left join usl_rdm_idl_spark_snp.crncy
  on optn.crncy_sk = crncy.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate r
  on crncy.crncy_sk = r.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate_dt r_dt
  on r.cbr_exchange_rate_sk = r_dt.cbr_exchange_rate_sk
  and r_dt.point_dt = current_date
  
left join usl_rdm_idl_spark_snp.crncy crncy_agr
  on agr.docum_tran_crncy_sk = crncy_agr.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate r_agr
  on crncy_agr.crncy_sk = r_agr.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate_dt r_dt_agr
  on r_agr.cbr_exchange_rate_sk = r_dt_agr.cbr_exchange_rate_sk
  and r_dt_agr.point_dt = current_date
where 1 = 1
  and optn.group_code in ('PrePay', 'Prepay', 'Pay', 'Expire'/*, 'ReturnCover'*/)
  and optn.type_code = 'Operation'
group by agr.agr_sk, optn.crncy_sk, agr.num
)

, EC AS       -- ÐŸÐ»Ð°Ñ‚ÐµÐ¶Ð¸ Ð² Ð²Ð°Ð»ÑŽÑ‚Ðµ ÑÐ´ÐµÐ»ÐºÐ¸
(
select 
  agr.agr_sk
  , agr.num
  , round(sum(
      case
        when (agr.docum_tran_crncy_sk = optn.crncy_sk) or (crncy.digital_code = '643' and crncy_agr.digital_code = '643') then optn.sum_opt_amt
        when crncy.digital_code != '643' and crncy_agr.digital_code = '643' then (optn.sum_opt_amt * r_dt.rub_rate_amt) / r_dt.qty_rub_cnt
        when crncy.digital_code = '643' and crncy_agr.digital_code != '643' then (optn.sum_opt_amt * r_dt_agr.qty_rub_cnt) / r_dt_agr.rub_rate_amt
        when crncy.digital_code != '643' and crncy_agr.digital_code != '643' then (optn.sum_opt_amt * r_dt.rub_rate_amt * r_dt_agr.qty_rub_cnt) / (r_dt.qty_rub_cnt * r_dt_agr.rub_rate_amt) 
        end), 2) as nSumPay
  , optn.crncy_sk
from agr_sk_list_fin agr
inner join operations_list optn
  on agr.agr_sk = optn.agr_sk
  
left join usl_rdm_idl_spark_snp.crncy
  on optn.crncy_sk = crncy.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate r
  on crncy.crncy_sk = r.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate_dt r_dt
  on r.cbr_exchange_rate_sk = r_dt.cbr_exchange_rate_sk
  and r_dt.point_dt = current_date
  
left join usl_rdm_idl_spark_snp.crncy crncy_agr
  on agr.docum_tran_crncy_sk = crncy_agr.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate r_agr
  on crncy_agr.crncy_sk = r_agr.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate_dt r_dt_agr
  on r_agr.cbr_exchange_rate_sk = r_dt_agr.cbr_exchange_rate_sk
  and r_dt_agr.point_dt = current_date
where 1 = 1
  and optn.group_code in ('PrePay', 'Prepay', 'Pay', 'ReturnCover')
  and optn.type_code = 'Operation'
group by agr.agr_sk, optn.crncy_sk, agr.num
)

, ERub AS     -- ÐŸÐ»Ð°Ñ‚ÐµÐ¶Ð¸ Ð² Ñ€ÑƒÐ±Ð»ÑÑ…
(
select 
  agr.agr_sk
  , agr.num
  , round(sum(
      case
        when crncy.digital_code = '643' then optn.sum_opt_amt
        when crncy.digital_code != '643' then (optn.sum_opt_amt * r_dt.rub_rate_amt) / r_dt.qty_rub_cnt
        end), 2) as nSumPay
  , optn.crncy_sk
from agr_sk_list_fin agr
inner join operations_list optn
  on agr.agr_sk = optn.agr_sk
left join usl_rdm_idl_spark_snp.crncy
  on optn.crncy_sk = crncy.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate r
  on crncy.crncy_sk = r.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate_dt r_dt
  on r.cbr_exchange_rate_sk = r_dt.cbr_exchange_rate_sk
  and r_dt.point_dt = current_date
where 1 = 1
  and optn.group_code in ('PrePay', 'Prepay', 'Pay', 'Expire', 'ReturnCover')
  and optn.type_code = 'Operation'
group by agr.agr_sk, optn.crncy_sk, agr.num
)

, ECRub AS    -- ÐŸÐ»Ð°Ñ‚ÐµÐ¶Ð¸ Ð² Ð²Ð°Ð»ÑŽÑ‚Ðµ ÑÐ´ÐµÐ»ÐºÐ¸
(
select 
  agr.agr_sk
  , agr.num
  , round(sum(
      case
        when crncy.digital_code = '643' then optn.sum_opt_amt
        when crncy.digital_code != '643' then (optn.sum_opt_amt * r_dt.rub_rate_amt) / r_dt.qty_rub_cnt
        end), 2) as nSumPay
  , optn.crncy_sk
from agr_sk_list_fin agr
inner join operations_list optn
  on agr.agr_sk = optn.agr_sk
left join usl_rdm_idl_spark_snp.crncy
  on optn.crncy_sk = crncy.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate r
  on crncy.crncy_sk = r.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate_dt r_dt
  on r.cbr_exchange_rate_sk = r_dt.cbr_exchange_rate_sk
  and r_dt.point_dt = current_date
where 1 = 1
  and optn.group_code in ('PrePay', 'Prepay', 'Pay', 'ReturnCover')
  and optn.type_code = 'Operation'
group by agr.agr_sk, optn.crncy_sk, agr.num
)

, F AS        -- Ð’Ð¾Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð² Ð²Ð°Ð»ÑŽÑ‚Ðµ Ð´Ð¾ÑÑŒÐµ
(
select 
  agr.agr_sk
  , agr.num
  , round(sum(optn.sum_opt_amt), 2) as nSumBankReturn
  , optn.crncy_sk
from agr_sk_list_fin agr
inner join operations_list optn
  on agr.agr_sk = optn.agr_sk
where 1 = 1
  and optn.group_code in ('BankReturn')
  and optn.type_code = 'Operation'
group by agr.agr_sk, optn.crncy_sk, agr.num
)

, FRub AS     -- Ð’Ð¾Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð² Ñ€ÑƒÐ±Ð»ÑÑ…
(
select 
  agr.agr_sk
  , agr.num
  , round(sum(
      case
        when crncy.digital_code = '643' then optn.sum_opt_amt
        when crncy.digital_code != '643' then (optn.sum_opt_amt * r_dt.rub_rate_amt) / r_dt.qty_rub_cnt
        end), 2) as nSumBankReturn
  , optn.crncy_sk
from agr_sk_list_fin agr
inner join operations_list optn
  on agr.agr_sk = optn.agr_sk
left join usl_rdm_idl_spark_snp.crncy
  on optn.crncy_sk = crncy.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate r
  on crncy.crncy_sk = r.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate_dt r_dt
  on r.cbr_exchange_rate_sk = r_dt.cbr_exchange_rate_sk
  and r_dt.point_dt = current_date
where 1 = 1
  and optn.group_code in ('BankReturn')
  and optn.type_code = 'Operation'
group by agr.agr_sk, optn.crncy_sk, agr.num
)

, DF AS       -- ÐžÑ‚Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ Ð² Ð²Ð°Ð»ÑŽÑ‚Ðµ ÑÐ´ÐµÐ»ÐºÐ¸
(
select 
  C.agr_sk
  , case
      when D.crncy_sk = C.docum_tran_crncy_sk then (D.nSumBankPay  - F.nSumBankReturn) 
      when crncy.digital_code != '643' and crncy_agr.digital_code = '643' then ((D.nSumBankPay  - F.nSumBankReturn) * r_dt.rub_rate_amt) / r_dt.qty_rub_cnt
      when crncy.digital_code = '643' and crncy_agr.digital_code != '643' then ((D.nSumBankPay  - F.nSumBankReturn) * r_dt_agr.qty_rub_cnt) / r_dt_agr.rub_rate_amt
      when crncy.digital_code != '643' and crncy_agr.digital_code != '643' then ((D.nSumBankPay  - F.nSumBankReturn) * r_dt.rub_rate_amt * r_dt_agr.qty_rub_cnt) / (r_dt.qty_rub_cnt * r_dt_agr.rub_rate_amt) 
      end as nSum
from agr_sk_list_fin C
inner join D
  on C.agr_sk = D.agr_sk
left join F
  on C.agr_sk = F.agr_sk

left join usl_rdm_idl_spark_snp.crncy
  on D.crncy_sk = crncy.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate r
  on crncy.crncy_sk = r.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate_dt r_dt
  on r.cbr_exchange_rate_sk = r_dt.cbr_exchange_rate_sk
  and r_dt.point_dt = current_date
  
left join usl_rdm_idl_spark_snp.crncy crncy_agr
  on C.docum_tran_crncy_sk = crncy_agr.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate r_agr
  on crncy_agr.crncy_sk = r_agr.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate_dt r_dt_agr
  on r_agr.cbr_exchange_rate_sk = r_dt_agr.cbr_exchange_rate_sk
  and r_dt_agr.point_dt = current_date
)

, DFRub AS    -- ÐžÑ‚Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ Ð² Ð²Ð°Ð»ÑŽÑ‚Ðµ ÑÐ´ÐµÐ»ÐºÐ¸
(
select 
  C.agr_sk
  , case
      when crncy.digital_code = '643' then (D.nSumBankPay  - F.nSumBankReturn)
      when crncy.digital_code != '643' then ((D.nSumBankPay  - F.nSumBankReturn) * r_dt.rub_rate_amt) / r_dt.qty_rub_cnt
      end as nSum
from agr_sk_list_fin C
inner join D
  on C.agr_sk = D.agr_sk
left join F
  on C.agr_sk = F.agr_sk

left join usl_rdm_idl_spark_snp.crncy
  on D.crncy_sk = crncy.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate r
  on crncy.crncy_sk = r.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate_dt r_dt
  on r.cbr_exchange_rate_sk = r_dt.cbr_exchange_rate_sk
  and r_dt.point_dt = current_date
)

, G AS        -- ÐŸÐ¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð² Ð²Ð°Ð»ÑŽÑ‚Ðµ Ð´Ð¾ÑÑŒÐµ
(
select 
  agr.agr_sk
  , agr.num
  , round(sum(
      case
        when (agr.docum_tran_crncy_sk = optn.crncy_sk) or (crncy.digital_code = '643' and crncy_agr.digital_code = '643') then optn.sum_opt_amt
        when crncy.digital_code != '643' and crncy_agr.digital_code = '643' then (optn.sum_opt_amt * r_dt.rub_rate_amt) / r_dt.qty_rub_cnt
        when crncy.digital_code = '643' and crncy_agr.digital_code != '643' then (optn.sum_opt_amt * r_dt_agr.qty_rub_cnt) / r_dt_agr.rub_rate_amt
        when crncy.digital_code != '643' and crncy_agr.digital_code != '643' then (optn.sum_opt_amt * r_dt.rub_rate_amt * r_dt_agr.qty_rub_cnt) / (r_dt.qty_rub_cnt * r_dt_agr.rub_rate_amt) 
        end), 2) as nSumCover
  , optn.crncy_sk
from agr_sk_list_fin agr
inner join operations_list optn
  on agr.agr_sk = optn.agr_sk
  
left join usl_rdm_idl_spark_snp.crncy
  on optn.crncy_sk = crncy.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate r
  on crncy.crncy_sk = r.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate_dt r_dt
  on r.cbr_exchange_rate_sk = r_dt.cbr_exchange_rate_sk
  and r_dt.point_dt = current_date
  
left join usl_rdm_idl_spark_snp.crncy crncy_agr
  on agr.docum_tran_crncy_sk = crncy_agr.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate r_agr
  on crncy_agr.crncy_sk = r_agr.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate_dt r_dt_agr
  on r_agr.cbr_exchange_rate_sk = r_dt_agr.cbr_exchange_rate_sk
  and r_dt_agr.point_dt = current_date
where 1 = 1
  and optn.group_code in ('Cover')
  and optn.type_code = 'Operation'
group by agr.agr_sk, optn.crncy_sk, agr.num
)

, GRub AS     -- ÐŸÐ¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð² Ñ€ÑƒÐ±Ð»ÑÑ…
(
select 
  agr.agr_sk
  , agr.num
  , round(sum(
      case
        when crncy.digital_code = '643' then optn.sum_opt_amt
        when crncy.digital_code != '643' then (optn.sum_opt_amt * r_dt.rub_rate_amt) / r_dt.qty_rub_cnt
        end), 2) as nSumCover
  , optn.crncy_sk
from agr_sk_list_fin agr
inner join operations_list optn
  on agr.agr_sk = optn.agr_sk
left join usl_rdm_idl_spark_snp.crncy
  on optn.crncy_sk = crncy.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate r
  on crncy.crncy_sk = r.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate_dt r_dt
  on r.cbr_exchange_rate_sk = r_dt.cbr_exchange_rate_sk
  and r_dt.point_dt = current_date
where 1 = 1
  and optn.group_code in ('Cover')
  and optn.type_code = 'Operation'
group by agr.agr_sk, optn.crncy_sk, agr.num
)

, BRPlan AS   -- Ð”Ð»Ñ ÑÐ´ÐµÐ»Ð¾Ðº Ð¾Ñ‚Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð´Ð°Ñ‚Ñƒ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð¿Ð»Ð°Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð²Ð¾Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ \ Ð¿Ð»Ð°Ð½Ð¾Ð²Ð¾Ð¹ Ð´Ð°Ñ‚Ñ‹ Ð¿Ð¾Ð³Ð°ÑˆÐµÐ½Ð¸Ñ Ð´Ð¾ÑÑ€Ð¾Ñ‡Ð½Ð¾Ð³Ð¾ Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð°
(
select 
  agr.agr_sk
  , agr.num
  , MAX(optn.optn_dttm) AS dDate
from agr_sk_list_fin agr
inner join operations_list optn
  on agr.agr_sk = optn.agr_sk
where 1 = 1
  and optn.group_code in ('Request', 'ReturnSchedule','DeferPayReturn')
group by agr.agr_sk, agr.num
)

, BRFact AS   -- Ð”Ð»Ñ ÑÐ´ÐµÐ»Ð¾Ðº Ð¾Ñ‚Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð´Ð°Ñ‚Ñƒ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð¿Ð»Ð°Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð²Ð¾Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ
(
select 
  agr.agr_sk
  , agr.num
  , MAX(optn.optn_dttm) AS dDate
from agr_sk_list_fin agr
inner join operations_list optn
  on agr.agr_sk = optn.agr_sk
where 1 = 1
  and optn.group_code in ('BankReturn')
group by agr.agr_sk, agr.num
)

---- MAIN SELECT
select distinct
  C.sid                             as `ID Ð°ÐºÐºÑ€ÐµÐ´Ð¸Ñ‚Ð¸Ð²Ð° Ð² dflike`
  , C.num                           as `ÐÐ¾Ð¼ÐµÑ€ Ð°ÐºÐºÑ€ÐµÐ´Ð¸Ñ‚Ð¸Ð²Ð°`
  , cast(C.docum_tran_amt as float) as `Ð¡ÑƒÐ¼Ð¼Ð° Ð°ÐºÐºÑ€ÐµÐ´Ð¸Ñ‚Ð¸Ð²Ð° (Ð½Ð° Ð´Ð°Ñ‚Ñƒ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ñ)`
  , crncy.iso_code                  as `Ð’Ð°Ð»ÑŽÑ‚Ð° Ð°ÐºÐºÑ€ÐµÐ´Ð¸Ñ‚Ð¸Ð²Ð°`
  , C.open_dt                       as `Ð”Ð°Ñ‚Ð° Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ñ`
  , C.close_dt                      as `Ð”Ð°Ñ‚Ð° Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ`
  , agr_cond.mat_dt                 as `Ð”Ð°Ñ‚Ð° Ð¸ÑÑ‚ÐµÑ‡ÐµÐ½Ð¸Ñ (Ð´Ð°Ñ‚Ð° Ð¿Ð¾Ð³Ð°ÑˆÐµÐ½Ð¸Ñ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÑÑ‚Ð² Ð¿Ð¾ Ð°ÐºÐºÑ€ÐµÐ´Ð¸Ñ‚Ð¸Ð²Ñƒ)`
  , C.letter_cred_coverage_flag     as `Ð¤Ð»Ð°Ð³ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¾Ð³Ð¾ Ð°ÐºÐºÑ€Ð´Ð¸Ñ‚Ð¸Ð²Ð°`
  , lcs.letter_cred_source_coverage_type_name   as `Ð¢Ð¸Ð¿ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ° Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ`
  , cast(round(
      case
        when C.letter_cred_coverage_flag = false then round(agr_fin.docum_tran_amt, 2)
        when C.letter_cred_coverage_flag = true then round(coalesce(G.nSumCover, 0), 2)
      end 
    - 
      case
        when C.letter_cred_coverage_flag = false then round(coalesce(E.nSumPay, 0), 2)
        when C.letter_cred_coverage_flag = true then round(coalesce(EC.nSumPay, 0), 2)
      end
    + 
      coalesce(DF.nSum, 0) , 2) as float)     as `ÐžÑÑ‚Ð°Ñ‚Ð¾Ðº Ð² Ð²Ð°Ð»ÑŽÑ‚Ðµ Ð°ÐºÐºÑ€ÐµÐ´Ð¸Ñ‚Ð¸Ð²Ð° (Ð½Ð° Ð´Ð°Ñ‚Ñƒ Ð¾ÐºÐ¾Ð½Ñ‡Ð°Ð½Ð¸Ñ Ð¿ÐµÑ€Ð¸Ð¾Ð´Ð°)`
  , cast(agr_fin.docum_tran_amt as float)     as `Ð¡ÑƒÐ¼Ð¼Ð° ÑÐ´ÐµÐ»ÐºÐ¸ ÐÐŸÐ Ð½Ð° Ð´Ð°Ñ‚Ñƒ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°`
  , cast(coalesce(G.nSumCover, 0) as float)   as `Ð¡ÑƒÐ¼Ð¼Ð° ÑÐ´ÐµÐ»ÐºÐ¸ ÐŸÐ Ð½Ð° Ð´Ð°Ñ‚Ñƒ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°`
  , cast(coalesce(DF.nSum, 0) as float)       as `ÐÐµÐ²Ð¾Ð·Ð¼ÐµÑ‰ÐµÐ½Ð½Ð¾Ðµ Ð¾Ñ‚Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ Ð² Ð²Ð°Ð»ÑŽÑ‚Ðµ ÑÐ´ÐµÐ»ÐºÐ¸`
  , cast(round(
      case
        when C.letter_cred_coverage_flag = false then
          case
            when crncy_2.digital_code = '643' then round(agr_fin.docum_tran_amt, 2)
						else ((agr_fin.docum_tran_amt * r_dt.rub_rate_amt) / r_dt.qty_rub_cnt) 
            end
        when C.letter_cred_coverage_flag = true then coalesce(GRub.nSumCover, 0)
      end  
    -
      case
        when C.letter_cred_coverage_flag = false then coalesce(ERub.nSumPay, 0)
        when C.letter_cred_coverage_flag = true then coalesce(ECRub.nSumPay, 0)
      end 
    +
      coalesce(DFRub.nSum, 0), 2) as float)   as `ÐžÑÑ‚Ð°Ñ‚Ð¾Ðº (Ð½Ð° Ð´Ð°Ñ‚Ñƒ Ð¾ÐºÐ¾Ð½Ñ‡Ð°Ð½Ð¸Ñ Ð¿ÐµÑ€Ð¸Ð¾Ð´Ð°) (Ñ€ÑƒÐ±.)`
  , cast(agr_fin.docum_tran_amt as float)     as `Ð¡ÑƒÐ¼Ð¼Ð° ÑÐ´ÐµÐ»ÐºÐ¸ ÐÐŸÐ Ð½Ð° Ð´Ð°Ñ‚Ñƒ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° ÐµÑÐ»Ð¸ Ð²Ð°Ð»ÑŽÑ‚Ð° RUR`
  , cast(round(((agr_fin.docum_tran_amt * r_dt.rub_rate_amt) / r_dt.qty_rub_cnt), 2) as float)    as `Ð¡ÑƒÐ¼Ð¼Ð° ÑÐ´ÐµÐ»ÐºÐ¸ ÐÐŸÐ Ð½Ð° Ð´Ð°Ñ‚Ñƒ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° ÐµÑÐ»Ð¸ Ð²Ð°Ð»ÑŽÑ‚Ð° Ð½Ðµ RUR`
  , r_dt.rub_rate_amt                         as `ÐšÑƒÑ€Ñ nr`
  , r_dt.qty_rub_cnt                          as `ÐšÑƒÑ€Ñ nv`
  , cast(coalesce(DFRub.nSum, 0) as float)    as `ÐÐµÐ²Ð¾Ð·Ð¼ÐµÑ‰ÐµÐ½Ð½Ð¾Ðµ Ð¾Ñ‚Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ Ð² Ñ€ÑƒÐ±Ð»ÑÑ…`
  , cast(coalesce(B.nSumDeferSB, 0) as float) as `ÐŸÐ»Ð°Ñ‚Ð° Ð·Ð° Ð¾Ñ‚ÑÑ€Ð¾Ñ‡ÐºÑƒ Ð‘Ð°Ð½ÐºÐ°, ÑÐ¿Ð¸ÑÐ°Ð½Ð½Ð°Ñ Ð·Ð° Ð¾Ñ‚Ñ‡ÐµÑ‚Ð½Ñ‹Ð¹ Ð¿ÐµÑ€Ð¸Ð¾Ð´`
  , crncy_b.iso_code                          as `Ð’Ð°Ð»ÑŽÑ‚Ð° Ð¿Ð»Ð°Ñ‚Ñ‹`
  , cast(coalesce(A.nSumPercent, 0) as float) as `Ð’Ñ‹Ð¿Ð»Ð°Ñ‡ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ñ‹ Ð½Ð° Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ðº Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ`
  , crncy_a.iso_code                          as `Ð’Ð°Ð»ÑŽÑ‚Ð° Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð¾Ð²`
  , case when optn_m.agr_sk is null then false else true end  as `ÐŸÑ€Ð¸Ð·Ð½Ð°Ðº Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸`
from agr_sk_list_fin C
left join A 
  on C.agr_sk = A.agr_sk
left join B 
  on C.agr_sk = B.agr_sk
left join D 
  on C.agr_sk = D.agr_sk
left join F 
  on C.agr_sk = F.agr_sk
left join DF 
  on C.agr_sk = DF.agr_sk
left join DFRub 
  on C.agr_sk = DFRub.agr_sk
left join E 
  on C.agr_sk = E.agr_sk
left join ERub 
  on C.agr_sk = ERub.agr_sk
left join EC 
  on C.agr_sk = EC.agr_sk
left join ECRub 
  on C.agr_sk = ECRub.agr_sk
left join G 
  on C.agr_sk = G.agr_sk
left join GRub 
  on C.agr_sk = GRub.agr_sk
left join BRPlan 
  on C.agr_sk = BRPlan.agr_sk
left join BRFact 
  on C.agr_sk = BRFact.agr_sk
left join operations_list optn 
  on C.agr_sk = optn.agr_sk
left join operations_list optn_m 
  on C.agr_sk = optn_m.agr_sk and optn_m.group_code in ('Migration')
left join usl_tradefin_ndl_uvdo_snp.letter_cred_source_coverage_type lcs 
  on C.letter_cred_source_coverage_type_sk = lcs.letter_cred_source_coverage_type_sk
left join usl_rdm_idl_spark_snp.crncy
  on C.docum_tran_crncy_sk = crncy.crncy_sk
left join usl_tradefin_ndl_uvdo_snp.agr_cond
  on C.agr_sk = agr_cond.agr_sk and agr_cond.end_dt = '9999-12-31'
left join usl_tradefin_ndl_uvdo_snp.agr_fin
  on C.agr_sk = agr_fin.agr_sk and current_date >= agr_fin.start_dt and current_date < agr_fin.end_dt
left join usl_rdm_idl_spark_snp.crncy crncy_2
  on agr_fin.docum_tran_crncy_sk = crncy_2.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate r
  on crncy.crncy_sk = r.crncy_sk
left join usl_gmrates_idl_snp.cbr_exchange_rate_dt r_dt
  on r.cbr_exchange_rate_sk = r_dt.cbr_exchange_rate_sk
  and r_dt.point_dt = current_date
left join usl_rdm_idl_spark_snp.crncy crncy_b
  on B.crncy_sk = crncy_b.crncy_sk
left join usl_rdm_idl_spark_snp.crncy crncy_a
  on A.crncy_sk = crncy_a.crncy_sk
Ð’Ð¾Ñ‚ **Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¹ Ð¸ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚** Ð´Ð»Ñ Ð¿Ð¾ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¸Ñ Ð²Ð¸Ñ‚Ñ€Ð¸Ð½Ñ‹ Ð°ÐºÐºÑ€ÐµÐ´Ð¸Ñ‚Ð¸Ð²Ð¾Ð².

---

âœ… **Ð§Ñ‚Ð¾ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾:**
- Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ñ‹ **Ð½ÐµÐ¾Ð´Ð½Ð¾Ð·Ð½Ð°Ñ‡Ð½Ñ‹Ðµ Ð¿Ð¾Ð»Ñ** (`type_code`, `group_code`).
- ÐŸÐ¾Ð»Ñ Ð±ÐµÑ€ÑƒÑ‚ÑÑ **Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¸Ð· `agr_fin`**, Ð³Ð´Ðµ Ð½ÑƒÐ¶Ð½Ð¾ (`docum_tran_crncy_sk`).
- **ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ `optn`** â€” Ñ„Ð¸Ð»ÑŒÑ‚Ñ€ Ð¿Ð¾ Ð´Ð°Ñ‚Ðµ **Ð´Ð¾ `join`**.
- `broadcast` Ð´Ð»Ñ `toptn` â€” ÑƒÑÐºÐ¾Ñ€ÐµÐ½Ð¸Ðµ.
- ÐšÐµÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾Ð¼ÐµÐ¶ÑƒÑ‚Ð¾Ñ‡Ð½Ñ‹Ñ… Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð².
- Ð Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð½Ð° Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…, Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ `optn` â€” Ð¼Ð¸Ð»Ð»Ð¸Ð°Ñ€Ð´ ÑÑ‚Ñ€Ð¾Ðº.

---

```scala
// === ÐŸÐžÐ›ÐÐ«Ð™ Ð¡ÐšÐ Ð˜ÐŸÐ¢: Ð’Ð¸Ñ‚Ñ€Ð¸Ð½Ð° Ð°ÐºÐºÑ€ÐµÐ´Ð¸Ñ‚Ð¸Ð²Ð¾Ð² (Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ) ===
// ÐÐ²Ñ‚Ð¾Ñ€: GigaCode
// Ð¦ÐµÐ»ÑŒ: Ð¿Ð¾ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Ð²Ð¸Ñ‚Ñ€Ð¸Ð½Ñƒ Ð½Ð° businessDate Ñ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½ÐµÐ¼ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ

import org.apache.spark.sql.SparkSession
import org.apache.spark.sql.functions._
import spark.implicits._

// --- ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ ---
val businessDate = "2025-03-10"  // Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· spark.conf
val trade_snp = "usl_tradefin_ndl_uvdo_snp"
val rdm_idl_spark = "usl_rdm_idl_spark_snp"

println(s"âœ… Ð—Ð°Ð¿ÑƒÑÐº Ð½Ð° Ð´Ð°Ñ‚Ñƒ: $businessDate")
```

```scala
// --- 1. ÐÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ðµ ÑÐ´ÐµÐ»ÐºÐ¸ Ð½Ð° Ð´Ð°Ñ‚Ñƒ (Ð¸Ð· agr) ---
val activeAgreements = spark
  .table(s"$trade_snp.agr")
  .filter(
    col("open_dt") < lit(businessDate) &&
    (col("close_dt").isNull || col("close_dt") > lit(businessDate))
  )
  .select(
    col("agr_sk"),
    col("letter_cred_type_sk"),
    col("type_code"),
    col("num"),
    col("open_dt"),
    col("close_dt"),
    col("letter_cred_coverage_flag")
  )
```

```scala
// --- 2. Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ Ð¿Ð¾ Ñ‚Ð¸Ð¿Ñƒ Ð°ÐºÐºÑ€ÐµÐ´Ð¸Ñ‚Ð¸Ð²Ð° ---
val accreditedAgreements = activeAgreements
  .join(
    spark.table(s"$trade_snp.letter_cred_type").alias("lct"),
    Seq("letter_cred_type_sk"),
    "inner"
  )
  .filter(
    col("lct.sid").isin("1", "2", "10") ||
    col("agr.type_code").isin("ind", "ind_draft")
  )
  .select(
    col("agr_sk"),
    col("num").alias("acc_number"),
    col("open_dt"),
    col("close_dt"),
    col("letter_cred_coverage_flag").alias("coverage_flag")
  )
```

```scala
// --- 3. Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ (Ð¸Ð· agr_fin) ---
val finData = spark
  .table(s"$trade_snp.agr_fin")
  .filter(col("end_dt") === "9999-12-31")
  .select(
    col("agr_sk"),
    col("docum_tran_amt").alias("amount"),
    col("docum_tran_crncy_sk")
  )
```

```scala
// --- 4. ÐžÐ¿ÐµÑ€Ð°Ñ†Ð¸Ð¸: BankPay Ð¸ BankReturn (Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾!) ---

// ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½: Ð·Ð° 2 Ð³Ð¾Ð´Ð° Ð´Ð¾ businessDate (Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ Ð¿Ð¾Ð´ ÑÐµÐ±Ñ)
val lookbackDays = 730
val startDate = date_add(lit(businessDate), -lookbackDays)

val optn = spark.table(s"$trade_snp.optn").alias("optn")
val toptn = spark.table(s"$trade_snp.toptn").alias("toptn")

// ðŸ”¥ Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ: Ñ„Ð¸Ð»ÑŒÑ‚Ñ€ Ð¿Ð¾ Ð´Ð°Ñ‚Ðµ â€” Ð”Ðž join!
val operations = optn
  .filter(col("optn_dttm") >= startDate)  // âœ… Ð§Ð¸Ñ‚Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½ÑƒÐ¶Ð½Ñ‹Ðµ Ð¿Ð°Ñ€Ñ‚Ð¸Ñ†Ð¸Ð¸
  .filter(col("optn_dttm") <= lit(businessDate))
  .join(
    broadcast(toptn),  // âœ… toptn â€” Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÐ¸Ð¹ ÑÐ¿Ñ€Ð°Ð²Ð¾Ñ‡Ð½Ð¸Ðº â†’ broadcast
    Seq("toptn_sk"),
    "left"
  )
  .filter(
    col("optn.type_code") === "Operation" &&
    col("toptn.group_code").isin("BankPay", "BankReturn")
  )
  .select(
    col("optn.agr_sk"),
    col("optn.sum_opt_amt"),
    col("toptn.group_code")
  )
```

```scala
// --- 5. Ð Ð°ÑÑ‡Ñ‘Ñ‚ Ð¾Ñ‚Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ ---
val bankPay = operations
  .filter(col("group_code") === "BankPay")
  .groupBy("agr_sk")
  .agg(sum("sum_opt_amt").alias("sum_bank_pay"))

val bankReturn = operations
  .filter(col("group_code") === "BankReturn")
  .groupBy("agr_sk")
  .agg(sum("sum_opt_amt").alias("sum_bank_return"))

val netDiversion = bankPay
  .join(bankReturn, Seq("agr_sk"), "left")
  .withColumn(
    "net_diversion_amt",
    coalesce(col("sum_bank_pay"), lit(0)) - coalesce(col("sum_bank_return"), lit(0))
  )
  .select("agr_sk", "net_diversion_amt")
  .cache()  // âœ… ÐšÐµÑˆÐ¸Ñ€ÑƒÐµÐ¼ â€” Ð¼Ð¾Ð¶ÐµÑ‚ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒÑÑ Ð´Ð²Ð°Ð¶Ð´Ñ‹

// Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€
netDiversion.count()
```

```scala
// --- 6. Ð¡Ð¿Ñ€Ð°Ð²Ð¾Ñ‡Ð½Ð¸Ðº Ð²Ð°Ð»ÑŽÑ‚ ---
val currency = spark
  .table(s"$rdm_idl_spark.crncy")
  .select("crncy_sk", "iso_code")
```

```scala
// --- 7. Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ ---
val result = accreditedAgreements
  .join(finData, Seq("agr_sk"), "inner")  // âœ… Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑÑƒÐ¼Ð¼Ñƒ Ð¸ Ð²Ð°Ð»ÑŽÑ‚Ñƒ
  .join(netDiversion, Seq("agr_sk"), "left")  // âœ… ÐžÑ‚Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ
  .join(currency, col("docum_tran_crncy_sk") === col("crncy_sk"), "left")  // âœ… ISO
  .withColumn(
    "tech_hash",
    md5(
      concat(
        coalesce(col("acc_number"), lit("")),
        coalesce(col("amount").cast("string"), lit("0")),
        coalesce(col("net_diversion_amt").cast("string"), lit("0")),
        coalesce(col("coverage_flag").cast("string"), lit("false"))
      )
    )
  )
  .select(
    col("agr_sk"),
    col("acc_number"),
    col("amount"),
    col("iso_code").alias("currency_code"),
    col("open_dt"),
    col("close_dt"),
    col("coverage_flag"),
    col("net_diversion_amt"),
    lit(0).cast("decimal(18,2)").alias("net_diversion_rur"),
    col("tech_hash")
  )
```

```scala
// --- Ð’Ñ‹Ð²Ð¾Ð´ ---
println(s"âœ… Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð²Ð¸Ñ‚Ñ€Ð¸Ð½Ð°: ${result.count()} Ð·Ð°Ð¿Ð¸ÑÐµÐ¹")
result.show(10, truncate = false)
```

---

## ðŸ”§ Ð§Ñ‚Ð¾ Ð¼Ð¾Ð¶Ð½Ð¾ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð´ ÑÐµÐ±Ñ

| ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€ | Ð“Ð´Ðµ Ð¼ÐµÐ½ÑÑ‚ÑŒ |
|--------|-----------|
| `businessDate` | ÐŸÐµÑ€Ð²Ð°Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ |
| `lookbackDays` | Ð¡ÐºÐ¾Ð»ÑŒÐºÐ¾ Ð»ÐµÑ‚ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹ ÑƒÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ñ‚ÑŒ |
| `optn` Ð¿Ð°Ñ€Ñ‚Ð¸Ñ†Ð¸Ð¸ | Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ `p10day`, Spark ÑÐ°Ð¼ Ð¾Ñ‚Ñ„Ð¸Ð»ÑŒÑ‚Ñ€ÑƒÐµÑ‚ |
| `cache()` | ÐžÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ, ÐµÑÐ»Ð¸ `netDiversion` Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð´Ð²Ð°Ð¶Ð´Ñ‹ |

---

## ðŸš€ Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸

1. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸ **Ð¿Ð¾ Ð±Ð»Ð¾ÐºÐ°Ð¼** â€” Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð¸, Ð³Ð´Ðµ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ°.
2. ÐžÑ‚ÐºÑ€Ð¾Ð¹ **Spark UI** â€” Ð½Ð°Ð¹Ð´Ð¸ ÑÐ°Ð¼ÑƒÑŽ Ð´Ð¾Ð»Ð³ÑƒÑŽ ÑÑ‚Ð°Ð´Ð¸ÑŽ.
3. Ð•ÑÐ»Ð¸ `optn` â€” 100+ GB â€” ÑƒÐ¼ÐµÐ½ÑŒÑˆÐ¸ `lookbackDays` Ð´Ð¾ 365 Ð¸Ð»Ð¸ 180.
4. Ð£Ð±ÐµÐ´Ð¸ÑÑŒ, Ñ‡Ñ‚Ð¾ `optn` Ð¿Ð°Ñ€Ñ‚Ð¸Ñ†Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð° â€” Ð¸Ð½Ð°Ñ‡Ðµ Ð±ÑƒÐ´ÐµÑ‚ Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ð¾.

---

Ð¢Ñ‹ Ð¿Ð¾Ñ‡Ñ‚Ð¸ Ñƒ Ñ†ÐµÐ»Ð¸.  
Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ð·Ð°Ð¿ÑƒÑÐºÑƒ.

ÐŸÐ¸ÑˆÐ¸, ÐµÑÐ»Ð¸ Ð±ÑƒÐ´ÑƒÑ‚ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ â€” Ð¿Ð¾Ð¼Ð¾Ð³Ñƒ ÑÑ€Ð°Ð·Ñƒ ðŸ‘‡
